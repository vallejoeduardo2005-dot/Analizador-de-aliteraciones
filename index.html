<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Detector de aliteraciones — consonantes (v3) — modo versos (FIXED)</title>
<style>
  body { font-family: Inter, "Segoe UI", Roboto, sans-serif; padding: 18px; background:#fafafa; color:#222; }
  h1 { margin-top:0; }
  textarea { width:100%; height:140px; padding:10px; font-size:16px; border-radius:8px; border:1px solid #ddd; resize:vertical; }
  #controls { margin:10px 0 18px; display:flex; gap:8px; align-items:center; }
  button { padding:8px 12px; border-radius:8px; border:none; background:#2563eb; color:white; cursor:pointer; }
  button.secondary { background:#6b7280; }
  #output-box { background: #fff; border-radius:8px; box-shadow: rgba(0,0,0,0.08) 0 2px 12px; padding:12px; height:240px; overflow:auto; white-space:pre-wrap; line-height:1.6; }
  .token { padding:0 .12em; border-radius:4px; display:inline; margin:0 .12em; font-size:inherit; line-height:inherit; vertical-align:baseline; }
  .legend { margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
  .legend .item { display:flex; gap:6px; align-items:center; font-size:13px; }
  .swatch { width:18px; height:14px; border-radius:4px; border:1px solid rgba(0,0,0,0.08); }
  .sound-1  { background: #FFFF00; }
  .sound-2  { background: #1E88E5; }
  .sound-3  { background: #E53935; }
  .sound-4  { background: #FB8C00; }
  .sound-5  { background: #8E24AA; }
  .sound-6  { background: #43A047; }
  .sound-7  { background: #D4AF37; }
  .sound-8  { background: #81D4FA; }
  .sound-9  { background: #F48FB1; }
  .sound-10 { background: #A5D6A7; }
  .sound-11 { background: #CE93D8; }
  .sound-12 { background: #9E9E9E; }
  .sound-13 { background: #00897B; }
  .sound-14 { background: #6A0D2B; }
  .sound-15 { background: #FF00FF; }
  .sound-16 { background: #2E7D32; }
  .sound-17 { background: #795548; }
  .sound-18 { background: #CFD8DC; }
  .sound-19 { background: #00BCD4; }
  .sound-20 { background: #7E57C2; }
  .sound-21 { background: #FFB74D; }
</style>
</head>
<body>
  <h1>Detector de aliteraciones</h1>
  <p>Pega texto y pulsa <strong>Analizar</strong>. </p>

  <textarea id="input" placeholder="Pega aquí tu texto...">El carro corre con calma junto al río.
Pero la casa canta canciones claras.
Canción cantada: canc, cant.
brazo problema
reto cantar</textarea>

  <div id="controls">
    <button id="analyzeBtn">Analizar</button>
    <button id="clearBtn" class="secondary">Borrar</button>
    <label style="margin-left:auto; font-size:13px; color:#555;">Modo de proximidad:</label>
    <select id="modeSelect" style="font-size:13px; padding:6px; border-radius:6px;">
      <option value="versos" selected>Versos (verso actual o siguiente)</option>
      <option value="palabras">Palabras (±2 palabras / fallback caracteres)</option>
    </select>
  </div>

  <div id="output-box" aria-live="polite"></div>
  <div class="legend" id="legend"></div>

<script>
// Normalización: tratamos á/à/ä como 'a', etc.
const BASE_VOWELS = new Set(['a','e','i','o','u']);
function baseChar(ch) {
  if (!ch) return ch;
  return ch.normalize('NFD').replace(/[̀-ͯ]/g, '');
}
const isVowel = ch => {
  if (!ch) return false;
  const b = baseChar(ch).toLowerCase();
  return BASE_VOWELS.has(b);
};
const isLetter = ch => {
  if (!ch) return false;
  const b = baseChar(ch).toLowerCase();
  return /[a-zñ]/i.test(b);
};

// especiales para reglas de R/L
const SPECIAL_LEFT = new Set(['c','b','p','g']);
const SPECIAL_LEFT_R = new Set(['c','b','p','g','d']);

const SOUND_LABELS = {
  1: 'B/V (b, v)',
  2: 'C(a,u,o)/K/Q (c, k, q)',
  3: 'C(e,i)/S/X/Z (c, s, x, z)',
  4: 'G (g) — ga, gi, gu, go',
  5: 'J (j) y G+e (ja, je, ji, jo, ju; ge)',
  6: 'L (l)',
  7: 'L (l)',
  8: 'M/N (m, n) sonido 8',
  9: 'M (m) sonido 9',
  10:'N (n) sonido 10',
  11:'R / RR (r, rr)',
  12:'R (r) sonido 12',
  13:'R (r) sonido 13',
  14:'S/X/Z (s, x, z) final',
  15:'LL / Y (ll, y)',
  16:'P (p) sonido 16',
  17:'D (d) sonido 17',
  18:'T (t) sonido 18',
  19:'F (f) sonido 19',
  20:'R con izq c/b/p/g (gra, bre...)',
  21:'L con izq c/b/p/g (gla, ble...)'
};

/* DetectSegment: devuelve solo la(s) letra(s) consonánticas a colorear */
function detectSegment(textLower, i) {
  const n = textLower.length;
  const ch = textLower[i];
  const left = (i-1>=0) ? textLower[i-1] : null;
  const right = (i+1<n) ? textLower[i+1] : null;
  const right2 = (i+2<n) ? textLower[i+2] : null;

  if (ch === 'b' || ch === 'v') { if (isVowel(right)) return { sound:1, start:i, end:i+1 }; }
  if (ch === 'c') { if (right && /[aouáóúü]/.test(right)) return { sound:2, start:i, end:i+1 }; if (right && /[eiéí]/.test(right)) return { sound:3, start:i, end:i+1 }; }
  if (ch === 'g') { if (right && /[aiuoáíóúü]/.test(right)) return { sound:4, start:i, end:i+1 }; if (right && /[eé]/.test(right)) return { sound:5, start:i, end:i+1 }; }
  if (ch === 'j') { if (isVowel(right)) return { sound:5, start:i, end:i+1 }; }
  if (ch === 'k') { if (isVowel(right)) return { sound:2, start:i, end:i+1 }; }
  if (ch === 'q') { if (right === 'u' && isVowel(right2)) return { sound:2, start:i, end:i+1 }; if (right === 'u') return { sound:2, start:i, end:i+1 }; }

  if (ch === 'p') { if (isVowel(right)) return { sound:16, start:i, end:i+1 }; }
  if (ch === 'd') { if (isVowel(right)) return { sound:17, start:i, end:i+1 }; }
  if (ch === 't') { if (isVowel(right)) return { sound:18, start:i, end:i+1 }; }
  if (ch === 'f') { if (isVowel(right)) return { sound:19, start:i, end:i+1 }; }

  // LL dígrafo -> marcar las dos letras
  if (ch === 'l' && right === 'l') return { sound:15, start:i, end:i+2 };
  if (ch === 'l') {
    const leftIsSpecial = left && SPECIAL_LEFT.has(left);
    if (isVowel(left)) return { sound:6, start:i, end:i+1 };
    if (isVowel(right) && leftIsSpecial) return { sound:21, start:i, end:i+1 };
    if (isVowel(right) && !leftIsSpecial) return { sound:7, start:i, end:i+1 };
  }

  if (ch === 'm') { if (right && isLetter(right) && !isVowel(right)) return { sound:8, start:i, end:i+1 }; else if (right && isVowel(right)) return { sound:9, start:i, end:i+1 }; }

  if (ch === 'n') {
    const leftChar = left;
    const rightChar = right;
    const rightIsLetter = rightChar && isLetter(rightChar);
    if (isVowel(leftChar) && !rightIsLetter) return { sound:8, start:i, end:i+1 };
    if (isVowel(leftChar) && rightIsLetter && !isVowel(rightChar)) return { sound:8, start:i, end:i+1 };
    if (rightIsLetter && isVowel(rightChar)) return { sound:10, start:i, end:i+1 };
  }

  if (ch === 'r' && right === 'r') return { sound:11, start:i, end:i+2 };
  if (ch === 'r') {
    const leftChar = left;
    const rightChar = right;
    const leftIsLetter = leftChar && isLetter(leftChar);
    const rightIsLetter = rightChar && isLetter(rightChar);
    const leftIsVowel = isVowel(leftChar);
    const rightIsVowel = isVowel(rightChar);
    const leftBase = leftChar ? baseChar(leftChar).toLowerCase() : null;
    const leftIsSpecialR = leftBase && SPECIAL_LEFT_R.has(leftBase);

    if (leftIsSpecialR && rightIsVowel) return { sound:20, start:i, end:i+1 };
    if (!leftIsLetter && rightIsVowel) return { sound:11, start:i, end:i+1 };
    if (leftIsVowel && rightIsVowel) return { sound:12, start:i, end:i+1 };
    if (rightIsVowel && leftIsLetter && !leftIsVowel) return { sound:11, start:i, end:i+1 };
    if (leftIsVowel && (!rightIsLetter || (rightIsLetter && !rightIsVowel))) return { sound:13, start:i, end:i+1 };
  }

  if (ch === 's' || ch === 'x' || ch === 'z') {
    const rightIsLetter = right && isLetter(right);
    if (isVowel(right)) return { sound:3, start:i, end:i+1 };
    if (isVowel(left) && !rightIsLetter) return { sound:14, start:i, end:i+1 };
    if (isVowel(left) && rightIsLetter && !isVowel(right)) return { sound:14, start:i, end:i+1 };
  }
  if (ch === 'y') { if (isVowel(right)) return { sound:15, start:i, end:i+1 }; if (!right && isVowel(left)) return null; }

  return null;
}

function escapeHtml(s) { return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

function analyzeText(original) {
  const text = (original || '').normalize('NFC');
  const lower = text.toLowerCase();
  const n = text.length;

  // detectar segmentos consonánticos
  const segments = [];
  for (let i=0;i<n;i++) {
    const seg = detectSegment(lower, i);
    if (seg && seg.start >= 0 && seg.end <= n) {
      const existing = segments.find(s => s.start === seg.start);
      if (!existing || (seg.end - seg.start) > (existing.end - existing.start)) {
        segments.push({ start: seg.start, end: seg.end, sound: seg.sound });
      }
    }
  }
  segments.sort((a,b)=>a.start-b.start);

  // palabras
  const wordRegex = /\b[\wáéíóúüñÁÉÍÓÚÜÑ]+\b/g;
  const words = []; let m;
  while ((m = wordRegex.exec(text)) !== null) words.push({ start: m.index, end: m.index + m[0].length, text: m[0] });

  function findWordIndexForPos(pos) {
    for (let wi=0; wi<words.length; wi++) if (pos >= words[wi].start && pos < words[wi].end) return wi;
    let best=-1, bestDist=Infinity;
    for (let wi=0; wi<words.length; wi++) {
      const ws=words[wi].start, we=words[wi].end;
      const dist = pos < ws ? ws-pos : (pos >= we ? pos-(we-1) : 0);
      if (dist < bestDist) { bestDist = dist; best = wi; }
    }
    return best;
  }

  segments.forEach(s => { s.wordIndex = findWordIndexForPos(s.start); });

  // obtener versos (líneas)
  const rawLines = text.split(/\r?\n/);
  const lineStarts = [];
  let cursor = 0;
  for (let li=0; li<rawLines.length; li++) {
    lineStarts.push(cursor);
    cursor += rawLines[li].length + 1;
  }
  function findVerseIndexForPos(pos) {
    for (let li=0; li<rawLines.length; li++) {
      const ls = lineStarts[li];
      const le = ls + rawLines[li].length;
      if (pos >= ls && pos < le) return li;
    }
    return rawLines.length - 1;
  }

  segments.forEach(s => { s.verseIndex = findVerseIndexForPos(s.start); });

  // activar según modo
  const mode = (document.getElementById('modeSelect') || {value:'versos'}).value;
  const active = new Set();

  if (mode === 'versos') {
    for (let i=0;i<segments.length;i++){
      const si = segments[i];
      for (let j=0;j<segments.length;j++){
        if (i===j) continue;
        const sj = segments[j];
        if (sj.sound !== si.sound) continue;
        if (sj.verseIndex === si.verseIndex || sj.verseIndex === si.verseIndex + 1) {
          active.add(i); active.add(j);
        }
      }
    }
  } else {
    for (let i=0;i<segments.length;i++){
      const si = segments[i];
      if (si.wordIndex === -1) continue;
      for (let j=0;j<segments.length;j++){
        if (i===j) continue;
        const sj = segments[j];
        if (sj.sound !== si.sound) continue;
        if (sj.wordIndex === -1) continue;
        if (Math.abs(sj.wordIndex - si.wordIndex) <= MAX_WORD_DISTANCE || Math.abs(sj.start - si.start) <= MAX_CHAR_DISTANCE) {
          active.add(i); active.add(j);
        }
      }
    }
  }

  const startMap = new Map();
  active.forEach(idx => { const s = segments[idx]; const cur = startMap.get(s.start); if (!cur || (s.end - s.start) > (cur.end - cur.start)) startMap.set(s.start, s); });

  // generar html
  const consumed = Array(n).fill(false);
  let out = '';
  for (let i=0;i<n;i++){
    if (consumed[i]) continue;
    const seg = startMap.get(i);
    if (seg) {
      for (let k=seg.start;k<seg.end;k++) consumed[k]=true;
      const snippet = text.slice(seg.start, seg.end);
      out += `<span class="token sound-${seg.sound}" title="sonido ${seg.sound}">${escapeHtml(snippet)}</span>`;
      i = seg.end - 1;
    } else { consumed[i]=true; out += escapeHtml(text[i]); }
  }
  return out;
}

/* UI */
const input = document.getElementById('input');
const outBox = document.getElementById('output-box');
const analyzeBtn = document.getElementById('analyzeBtn');
const clearBtn = document.getElementById('clearBtn');

analyzeBtn.addEventListener('click', ()=>{ outBox.innerHTML = analyzeText(input.value); });
clearBtn.addEventListener('click', ()=>{ input.value=''; outBox.innerHTML=''; });

(function buildLegend(){ const legend = document.getElementById('legend'); for (const sid in SOUND_LABELS){ const div = document.createElement('div'); div.className='item'; const sw = document.createElement('span'); sw.className='swatch sound-'+sid; const lbl = document.createElement('span'); lbl.textContent = `Sonido ${sid}: ${SOUND_LABELS[sid]}`; div.appendChild(sw); div.appendChild(lbl); legend.appendChild(div); } })();
</script>
</body>
</html>
